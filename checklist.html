<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M8 護理排班系統 - 點班清單</title>
    <style>
        body {
            font-family: "Microsoft JhengHei UI", "微軟正黑體", sans-serif;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 150px;
            transition: padding-bottom 0.3s ease;
        }
        * {
            font-family: "Microsoft JhengHei UI", "微軟正黑體", sans-serif;
        }
        button,
        select,
        input,
        option {
            font-family: "Microsoft JhengHei UI", "微軟正黑體", sans-serif;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        .nav-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .nav-button.active {
            background-color: #42a5f5;
            color: white;
        }
        .checklist-container {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }
        .equipment-list {
            width: 350px;
            max-height: 600px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .equipment-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .equipment-item:hover {
            background-color: #e3f2fd;
        }
        .equipment-item.selected {
            background-color: #bbdefb;
            border-color: #42a5f5;
        }
        .equipment-item-count {
            background-color: #42a5f5;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            min-width: 40px;
            margin-right: 20px;
        }
        .beds-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }
        .bed-cell {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            min-height: 100px;
            max-height: 120px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .bed-number {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2196f3;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }
        .bed-equipment-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .bed-equipment-tag {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .bed-equipment-tag .remove-btn {
            color: #f44336;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .search-bar {
            margin-bottom: 15px;
        }
        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .equipment-list-title {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2196f3;
        }
        .add-equipment-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            width: 300px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-close {
            border: none;
            background: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: row;
            gap: 10px;
            z-index: 1000;
        }
        .floating-save-button {
            padding: 12px 24px;
            background-color: #FF9800;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
        }
        .notification.show {
            transform: translateX(0);
        }
        .inventory-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }
        .inventory-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .inventory-item {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            min-height: 36px;
        }
        .inventory-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        .inventory-count {
            background-color: #42a5f5;
            color: white;
            border-radius: 4px;
            padding: 3px 8px;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
            font-weight: bold;
        }
        .equipment-item .delete-btn {
            position: absolute;
            right: 10px;
            color: #f44336;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .equipment-item:hover .delete-btn {
            opacity: 1;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 150px);
        }
        .checklist-container {
            flex: 1;
            overflow: hidden;
        }
        .stats-bar {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2196f3;
        }
        .stat-label {
            font-size: 0.8em;
            color: #666;
        }
        /* 添加借出/借入区域样式 */
        .loan-section {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        .loan-tabs {
            display: flex;
            margin-bottom: 10px;
        }
        
        .loan-tab {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }
        
        .loan-tab.active {
            background-color: #42a5f5;
            color: white;
        }
        
        .loan-tab:first-child {
            border-radius: 4px 0 0 4px;
        }
        
        .loan-tab:last-child {
            border-radius: 0 4px 4px 0;
        }
        
        .loan-content {
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .loan-content.active {
            display: block;
        }
        
        .loan-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .loan-item:hover {
            background-color: #e3f2fd;
        }
        
        .loan-item.selected {
            background-color: #bbdefb;
            border-color: #42a5f5;
        }
        
        .loan-out-item {
            border-left: 4px solid #f44336;
        }
        
        .loan-in-item {
            border-left: 4px solid #ffc107;
        }
        
        /* 修改库存区域样式 */
        .inventory-count {
            background-color: #42a5f5;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            min-width: 40px;
            text-align: center;
        }
        
        /* 修改床位设备标签样式 */
        .bed-equipment-tag.loan-out {
            background-color: #ffebee;
            border-color: #f44336;
        }
        
        .bed-equipment-tag.loan-in {
            background-color: #fff8e1;
            border-color: #ffc107;
        }
        /* 標題容器樣式 */
        .title-container {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        .head-nurse {
            font-size: 1.5rem;
            color: #2196f3;
            font-weight: 500;
            white-space: nowrap;
            border-left: 2px solid #90caf9;
            padding-left: 30px;
        }
        /* 日期時間顯示樣式 */
        .datetime-display {
            margin-left: auto;
            text-align: right;
            color: #333;
        }
        .datetime-line {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 20px;
        }
        #currentDate {
            font-size: 1.4rem;
            font-weight: 500;
        }
        #currentTime {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        .action-button {
            padding: 8px 16px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .action-button:hover {
            background-color: #1976d2;
        }
        /* 左下角导航按钮容器 */
        .bottom-nav-buttons {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 900; /* 确保在其他元素上方，但在保存按钮下方 */
        }
        
        /* 调整保存按钮位置，避免与导航按钮重叠 */
        .action-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px; /* 保持在右下角 */
            display: flex;
            flex-direction: row;
            gap: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title-container">
            <h1>M8 護理排班系統</h1>
            <span class="head-nurse">病房護理長：鐘黛瑩</span>
            <div class="datetime-display">
                <div class="datetime-line">
                    <span id="currentDate"></span>
                    <span id="currentTime"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalEquipment">0</div>
                <div class="stat-label">設備總數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="assignedEquipment">0</div>
                <div class="stat-label">已分配設備</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="availableEquipment">0</div>
                <div class="stat-label">可用設備</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="loanOutTotal">0</div>
                <div class="stat-label">借出總數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="loanInTotal">0</div>
                <div class="stat-label">借入總數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bedsWithEquipment">0</div>
                <div class="stat-label">已配置床位</div>
            </div>
        </div>

        <div class="checklist-container">
            <div class="equipment-list">
                <div class="inventory-section">
                    <div class="inventory-title">
                        <h3 class="equipment-list-title">單位庫存區域</h3>
                    </div>
                    <div class="inventory-grid" id="inventoryGrid">
                        <!-- 库存项目将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 添加借出/借入区域 -->
                <div class="loan-section">
                    <div class="loan-tabs">
                        <button class="loan-tab active" onclick="showLoanTab('out')">借出區</button>
                        <button class="loan-tab" onclick="showLoanTab('in')">借入區</button>
                    </div>
                    <div class="loan-content active" id="loanOutContent">
                        <!-- 借出设备列表 -->
                        <div id="loanOutItems"></div>
                        <button class="add-equipment-btn" style="margin-top: 10px;" onclick="showLoanOutModal()">新增借出設備</button>
                    </div>
                    <div class="loan-content" id="loanInContent">
                        <!-- 借入设备列表 -->
                        <div id="loanInItems"></div>
                        <button class="add-equipment-btn" style="margin-top: 10px;" onclick="showLoanInModal()">新增借入設備</button>
                    </div>
                </div>
                
                <h3 class="equipment-list-title" style="margin-top: 20px;">單位設備清單</h3>
                <div class="search-bar">
                    <input type="text" id="equipmentSearch" placeholder="搜尋設備..." oninput="filterEquipment()">
                </div>
                <div id="equipmentItems">
                    <!-- 设备项目将通过JavaScript动态生成 -->
                </div>
                <button class="add-equipment-btn" style="margin-top: 10px;" onclick="showAddEquipmentModal()">新增單位設備</button>
            </div>
            
            <div class="beds-grid" id="bedsGrid">
                <!-- 床位格子将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 添加设备的模态框 -->
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal" id="equipmentModal">
        <div class="modal-header">
            <h3>新增設備</h3>
            <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div style="margin-bottom: 15px;">
                <label for="newEquipmentInput" style="display: block; margin-bottom: 5px;">設備名稱</label>
                <input type="text" id="newEquipmentInput" placeholder="輸入設備名稱" style="width: 100%;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="newEquipmentTotal" style="display: block; margin-bottom: 5px;">設備數量</label>
                <input type="number" id="newEquipmentTotal" value="1" min="1" style="width: 100%;">
            </div>
            <button onclick="addNewEquipment()" style="width: 100%; padding: 8px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                新增
            </button>
        </div>
    </div>

    <!-- 添加借出/借入设备的模态框 -->
    <div class="modal" id="loanOutModal">
        <div class="modal-header">
            <h3>新增借出設備</h3>
            <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div style="margin-bottom: 15px;">
                <label for="loanOutEquipment" style="display: block; margin-bottom: 5px;">設備名稱</label>
                <select id="loanOutEquipment" style="width: 100%;">
                    <!-- 选项将通过JavaScript动态生成 -->
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label for="loanOutQuantity" style="display: block; margin-bottom: 5px;">借出數量</label>
                <input type="number" id="loanOutQuantity" value="1" min="1" style="width: 100%;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="loanOutDepartment" style="display: block; margin-bottom: 5px;">借出單位</label>
                <input type="text" id="loanOutDepartment" placeholder="輸入借出單位" style="width: 100%;">
            </div>
            <button onclick="addLoanOutEquipment()" style="width: 100%; padding: 8px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                新增借出
            </button>
        </div>
    </div>

    <div class="modal" id="loanInModal">
        <div class="modal-header">
            <h3>新增借入設備</h3>
            <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div style="margin-bottom: 15px;">
                <label for="loanInName" style="display: block; margin-bottom: 5px;">設備名稱</label>
                <input type="text" id="loanInName" placeholder="輸入設備名稱" style="width: 100%;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="loanInQuantity" style="display: block; margin-bottom: 5px;">借入數量</label>
                <input type="number" id="loanInQuantity" value="1" min="1" style="width: 100%;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="loanInDepartment" style="display: block; margin-bottom: 5px;">借入單位</label>
                <input type="text" id="loanInDepartment" placeholder="輸入借入單位" style="width: 100%;">
            </div>
            <button onclick="addLoanInEquipment()" style="width: 100%; padding: 8px; background-color: #ffc107; color: white; border: none; border-radius: 4px; cursor: pointer;">
                新增借入
            </button>
        </div>
    </div>

    <div class="action-buttons">
        <button class="floating-save-button" onclick="saveChecklistData()">保存點班</button>
    </div>

    <div class="notification" id="notification"></div>

    <!-- 添加共享导航脚本 -->
    <script src="js/shared-navigation.js"></script>

    <script>
        // 修改预设设备列表
        const defaultEquipment = [
            { name: "IV Pump", total: 10, available: 10 },
            { name: "血氧機", total: 10, available: 10 },
            { name: "氧氣筒", total: 10, available: 10 },
            { name: "烤燈", total: 1, available: 1 },
            { name: "小床", total: 2, available: 2 },
            { name: "床磅", total: 1, available: 1 }
        ];

        // 设备使用记录
        let equipmentUsage = {};
        
        // 当前选中的设备
        let selectedEquipment = null;
        
        // 添加借出/借入设备数据
        let loanOutEquipment = [];
        let loanInEquipment = [];
        
        // 当前选中的借出/借入设备
        let selectedLoanType = null;
        let selectedLoanEquipment = null;
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 設置當前頁面標識
            localStorage.setItem('currentPage', 'checklist.html');
            
            // 更新標題
            document.querySelector('.title-container h1').textContent = 'M8 設備點班系統';
            
            initializeEquipmentList();
            initializeBedsGrid();
            initializeLoanOutItems();
            initializeLoanInItems();
            loadChecklistData();
            
            // 确保所有模态框的关闭按钮都绑定了hideModal函数
            document.querySelectorAll('.modal-close').forEach(button => {
                button.onclick = hideModal;
            });
            
            // 初始化日期時間
            updateDateTime();
            
            // 每分鐘更新一次
            setInterval(updateDateTime, 60000);
        });

        // 初始化设备列表
        function initializeEquipmentList() {
            const equipmentContainer = document.getElementById('equipmentItems');
            equipmentContainer.innerHTML = '';
            
            defaultEquipment.forEach(item => {
                const equipmentDiv = document.createElement('div');
                equipmentDiv.className = 'equipment-item';
                equipmentDiv.dataset.name = item.name;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = item.name;
                nameSpan.style.flex = '1';
                
                const countSpan = document.createElement('span');
                countSpan.className = 'equipment-item-count';
                countSpan.textContent = `${item.available}/${item.total}`;
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteEquipment(item.name);
                });
                
                equipmentDiv.appendChild(nameSpan);
                equipmentDiv.appendChild(countSpan);
                equipmentDiv.appendChild(deleteBtn);
                
                // 如果没有可用设备，禁用选择
                if (item.available <= 0) {
                    equipmentDiv.classList.add('disabled');
                    equipmentDiv.style.opacity = '0.5';
                    equipmentDiv.style.cursor = 'not-allowed';
                } else {
                    equipmentDiv.addEventListener('click', function() {
                        // 取消之前选中的设备
                        document.querySelectorAll('.equipment-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 选中当前设备
                        this.classList.add('selected');
                        selectedEquipment = this.dataset.name;
                    });
                }
                
                equipmentContainer.appendChild(equipmentDiv);
            });
            
            // 更新库存区域
            updateInventoryGrid();
            
            // 更新统计数据
            updateStatistics();
        }

        // 初始化床位格子
        function initializeBedsGrid() {
            const bedsGrid = document.getElementById('bedsGrid');
            bedsGrid.innerHTML = '';
            
            // 获取床位配置
            let bedConfig = JSON.parse(localStorage.getItem('bedConfig')) || {};
            
            for (let i = 1; i <= 36; i++) {
                const bedCell = document.createElement('div');
                bedCell.className = 'bed-cell';
                
                const bedNumber = document.createElement('div');
                bedNumber.className = 'bed-number';
                
                // 使用自定义名称或默认名称
                const bedId = `bed_${i-1}`;
                const displayName = bedConfig[bedId] || i.toString();
                bedNumber.textContent = `床位 ${displayName}`;
                
                const equipmentList = document.createElement('div');
                equipmentList.className = 'bed-equipment-list';
                equipmentList.dataset.bedNumber = i;
                
                // 添加点击事件，将选中的设备添加到床位
                bedCell.addEventListener('click', function() {
                    // 處理普通設備
                    if (selectedEquipment) {
                        addEquipmentToBed(selectedEquipment, i);
                    } 
                    // 處理借入設備
                    else if (selectedLoanType === 'in' && selectedLoanEquipment !== null) {
                        // 添加借入設備到床位
                        addLoanInEquipmentToBed(selectedLoanEquipment, i);
                    }
                    // 注意：借出設備不能添加到床位
                });
                
                bedCell.appendChild(bedNumber);
                bedCell.appendChild(equipmentList);
                bedsGrid.appendChild(bedCell);
            }
        }

        // 添加設備到床位
        function addEquipmentToBed(equipmentName, bedNumber) {
            // 查找設備
            const equipment = defaultEquipment.find(e => e.name === equipmentName);
            
            // 檢查是否還有可用數量
            if (!equipment || equipment.available <= 0) {
                return;
            }
            
            // 獲取床位的設備列表
            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
            
            // 創建設備標籤
            const equipmentTag = document.createElement('div');
            equipmentTag.className = 'bed-equipment-tag';
            equipmentTag.textContent = equipmentName;
            equipmentTag.dataset.name = equipmentName;
            
            // 添加刪除按鈕
            const deleteButton = document.createElement('span');
            deleteButton.className = 'delete-equipment';
            deleteButton.textContent = '×';
            deleteButton.setAttribute('onclick', 'removeEquipmentFromBed(this)');
            
            equipmentTag.appendChild(deleteButton);
            equipmentList.appendChild(equipmentTag);
            
            // 減少設備的可用數量
            equipment.available--;
            
            // 更新設備列表
            initializeEquipmentList();
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }

        // 從床位移除設備
        function removeEquipmentFromBed(deleteButton) {
            event.stopPropagation();
            
            // 獲取設備標籤和設備名稱
            const equipmentTag = deleteButton.parentElement;
            const equipmentName = equipmentTag.dataset.name;
            const isLoanIn = equipmentTag.classList.contains('loan-in');
            const isLoanOut = equipmentTag.classList.contains('loan-out');
            
            // 移除設備標籤
            equipmentTag.remove();
            
            if (isLoanIn) {
                // 恢復借入設備的可用數量
                const loanItem = loanInEquipment.find(item => item.name === equipmentName);
                if (loanItem) {
                    loanItem.available++;
                    // 更新借入設備列表
                    initializeLoanInItems();
                }
            } else if (!isLoanOut) {
                // 恢復普通設備的可用數量
                const equipment = defaultEquipment.find(e => e.name === equipmentName);
                if (equipment) {
                    equipment.available++;
                    // 更新設備列表
                    initializeEquipmentList();
                }
            }
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }

        // 更新库存区域
        function updateInventoryGrid() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = '';
            
            // 只显示有库存的设备
            defaultEquipment.forEach(item => {
                // 创建库存项
                const inventoryItem = document.createElement('div');
                inventoryItem.className = 'inventory-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'inventory-item-name';
                nameSpan.textContent = item.name;
                nameSpan.title = item.name; // 添加悬停提示，显示完整名称
                
                const countSpan = document.createElement('span');
                countSpan.className = 'inventory-count';
                countSpan.textContent = `${item.available}/${item.total}`;
                
                // 如果没有可用设备，显示灰色
                if (item.available <= 0) {
                    inventoryItem.style.opacity = '0.5';
                    countSpan.style.backgroundColor = '#999';
                }
                
                inventoryItem.appendChild(nameSpan);
                inventoryItem.appendChild(countSpan);
                
                // 点击库存项也可以选择设备
                inventoryItem.addEventListener('click', function() {
                    if (item.available > 0) {
                        document.querySelectorAll('.equipment-item').forEach(elem => {
                            elem.classList.remove('selected');
                        });
                        
                        const equipmentItem = document.querySelector(`.equipment-item[data-name="${item.name}"]`);
                        if (equipmentItem) {
                            equipmentItem.classList.add('selected');
                        }
                        
                        selectedEquipment = item.name;
                    }
                });
                
                inventoryGrid.appendChild(inventoryItem);
            });
        }

        // 过滤设备列表
        function filterEquipment() {
            const searchText = document.getElementById('equipmentSearch').value.toLowerCase();
            const equipmentItems = document.querySelectorAll('.equipment-item');
            
            equipmentItems.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                if (name.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 显示添加设备的模态框
        function showAddEquipmentModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('equipmentModal').style.display = 'block';
            document.getElementById('newEquipmentInput').focus();
        }

        // 修改隐藏模态框函数
        function hideModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
            document.getElementById('equipmentModal').style.display = 'none';
            document.getElementById('loanOutModal').style.display = 'none';
            document.getElementById('loanInModal').style.display = 'none';
            
            // 清空输入框
            if (document.getElementById('newEquipmentInput')) {
                document.getElementById('newEquipmentInput').value = '';
            }
            if (document.getElementById('loanInName')) {
                document.getElementById('loanInName').value = '';
            }
            if (document.getElementById('loanInDepartment')) {
                document.getElementById('loanInDepartment').value = '';
            }
            if (document.getElementById('loanOutDepartment')) {
                document.getElementById('loanOutDepartment').value = '';
            }
        }

        // 添加新设备
        function addNewEquipment() {
            const input = document.getElementById('newEquipmentInput');
            const name = input.value.trim();
            const totalInput = document.getElementById('newEquipmentTotal');
            const total = parseInt(totalInput.value) || 1;
            
            if (name) {
                // 检查是否已存在
                const existingEquipment = defaultEquipment.find(e => e.name === name);
                if (existingEquipment) {
                    showNotification('此設備已存在！', 'error');
                    return;
                }
                
                // 添加新设备
                defaultEquipment.push({
                    name: name,
                    total: total,
                    available: total
                });
                
                initializeEquipmentList();
                hideModal();
                showNotification('新設備已添加！');
            }
        }

        // 保存点班清单数据
        function saveChecklistData() {
            // 收集床位設備數據
            const bedsData = {};
            
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList) {
                    const equipmentTags = equipmentList.querySelectorAll('.bed-equipment-tag');
                    if (equipmentTags.length > 0) {
                        bedsData[i] = Array.from(equipmentTags).map(tag => {
                            const data = {
                                name: tag.dataset.name,
                                isLoanIn: tag.classList.contains('loan-in'),
                                isLoanOut: tag.classList.contains('loan-out')
                            };
                            
                            if (tag.dataset.source) {
                                data.source = tag.dataset.source;
                            }
                            
                            return data;
                        });
                    }
                }
            }
            
            // 準備保存的數據
            const dataToSave = {
                equipment: defaultEquipment,
                loanOut: loanOutEquipment,
                loanIn: loanInEquipment,
                beds: bedsData
            };
            
            // 保存到 localStorage
            localStorage.setItem('checklistData', JSON.stringify(dataToSave));
            
            showNotification('點班清單已保存！');
        }

        // 加载点班清单数据
        function loadChecklistData() {
            const savedData = localStorage.getItem('checklistData');
            if (!savedData) return;
            
            try {
                const data = JSON.parse(savedData);
                
                // 恢復設備數據
                if (data.equipment) {
                    defaultEquipment.length = 0; // 清空現有數據
                    data.equipment.forEach(item => defaultEquipment.push(item));
                }
                
                // 恢復借出設備數據
                if (data.loanOut) {
                    loanOutEquipment = data.loanOut;
                } else if (data.loanOutEquipment) {
                    // 兼容舊版數據格式
                    loanOutEquipment = data.loanOutEquipment;
                }
                
                // 恢復借入設備數據
                if (data.loanIn) {
                    loanInEquipment = data.loanIn;
                } else if (data.loanInEquipment) {
                    // 兼容舊版數據格式
                    loanInEquipment = data.loanInEquipment;
                }
                
                // 初始化設備列表
                initializeEquipmentList();
                initializeLoanOutItems();
                initializeLoanInItems();
                
                // 恢復床位設備數據
                if (data.beds && typeof data.beds === 'object' && !Array.isArray(data.beds)) {
                    // 新版數據格式
                    for (const bedNumber in data.beds) {
                        const bedEquipment = data.beds[bedNumber];
                        const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
                        
                        if (equipmentList && bedEquipment && bedEquipment.length > 0) {
                            // 清空現有設備
                            equipmentList.innerHTML = '';
                            
                            // 添加保存的設備
                            bedEquipment.forEach(eq => {
                                // 創建設備標籤
                                const equipmentTag = document.createElement('div');
                                
                                // 設置適當的類別
                                if (eq.isLoanIn) {
                                    equipmentTag.className = 'bed-equipment-tag loan-in';
                                } else if (eq.isLoanOut) {
                                    equipmentTag.className = 'bed-equipment-tag loan-out';
                                } else {
                                    equipmentTag.className = 'bed-equipment-tag';
                                }
                                
                                // 設置設備名稱
                                equipmentTag.textContent = eq.name;
                                equipmentTag.dataset.name = eq.name;
                                
                                if (eq.source) {
                                    equipmentTag.dataset.source = eq.source;
                                }
                                
                                // 添加刪除按鈕
                                const deleteButton = document.createElement('span');
                                deleteButton.className = 'delete-equipment';
                                deleteButton.textContent = '×';
                                deleteButton.setAttribute('onclick', 'removeEquipmentFromBed(this)');
                                
                                equipmentTag.appendChild(deleteButton);
                                equipmentList.appendChild(equipmentTag);
                            });
                        }
                    }
                } else if (data.beds && Array.isArray(data.beds)) {
                    // 舊版數據格式
                    data.beds.forEach(bedData => {
                        const bedNumber = bedData.bedNumber;
                        const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
                        
                        if (equipmentList && bedData.equipment && bedData.equipment.length > 0) {
                            // 清空現有設備
                            equipmentList.innerHTML = '';
                            
                            // 添加保存的設備
                            bedData.equipment.forEach(eq => {
                                // 創建設備標籤
                                const equipmentTag = document.createElement('div');
                                
                                // 設置適當的類別
                                if (eq.isLoanIn) {
                                    equipmentTag.className = 'bed-equipment-tag loan-in';
                                } else {
                                    equipmentTag.className = 'bed-equipment-tag';
                                }
                                
                                // 設置設備名稱
                                equipmentTag.textContent = eq.name;
                                equipmentTag.dataset.name = eq.name;
                                
                                // 添加刪除按鈕
                                const deleteButton = document.createElement('span');
                                deleteButton.className = 'delete-equipment';
                                deleteButton.textContent = '×';
                                deleteButton.setAttribute('onclick', 'removeEquipmentFromBed(this)');
                                
                                equipmentTag.appendChild(deleteButton);
                                equipmentList.appendChild(equipmentTag);
                            });
                        }
                    });
                }
                
                // 更新統計數據
                updateStatistics();
                
            } catch (error) {
                console.error('加載點班數據時出錯:', error);
            }
        }

        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#F44336';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 添加按Enter键提交功能
        document.getElementById('newEquipmentInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewEquipment();
            }
        });

        // 完善删除设备功能，添加防呆机制
        function deleteEquipment(equipmentName) {
            console.log("尝试删除设备:", equipmentName);
            
            // 检查设备是否已分配到床位
            let isAssigned = false;
            
            // 遍历所有床位，检查是否有该设备
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList) {
                    const equipmentTags = equipmentList.querySelectorAll('.bed-equipment-tag');
                    equipmentTags.forEach(tag => {
                        if (tag.dataset.name === equipmentName) {
                            isAssigned = true;
                        }
                    });
                }
                if (isAssigned) break;
            }
            
            // 如果设备已分配到床位，显示错误提示
            if (isAssigned) {
                showNotification('此設備使用中，無法進行變更', 'error');
                return;
            }
            
            // 二次确认
            if (confirm(`確定要刪除「${equipmentName}」設備嗎？此操作無法恢復。`)) {
                // 从设备列表中删除
                const index = defaultEquipment.findIndex(e => e.name === equipmentName);
                if (index !== -1) {
                    defaultEquipment.splice(index, 1);
                    initializeEquipmentList();
                    showNotification('設備已刪除');
                    saveChecklistData();
                }
            }
        }

        // 更新统计数据
        function updateStatistics() {
            // 計算設備總數 (只計算原始庫存，不包括借入設備)
            let totalEquipment = defaultEquipment.reduce((sum, item) => sum + item.total, 0);
            
            // 計算已分配設備
            let assignedEquipment = 0;
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList) {
                    // 只計算原始庫存設備和借出設備，不計算借入設備
                    const regularTags = equipmentList.querySelectorAll('.bed-equipment-tag:not(.loan-in)');
                    assignedEquipment += regularTags.length;
                }
            }
            
            // 計算可用設備 (只計算原始庫存，不包括借入設備)
            const availableEquipment = defaultEquipment.reduce((sum, item) => sum + item.available, 0);
            
            // 計算借出總數
            const loanOutTotal = loanOutEquipment.reduce((sum, item) => sum + item.quantity, 0);
            
            // 計算借入總數
            const loanInTotal = loanInEquipment.reduce((sum, item) => sum + item.count, 0);
            
            // 計算已配置床位數
            let bedsWithEquipment = 0;
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList && equipmentList.querySelectorAll('.bed-equipment-tag').length > 0) {
                    bedsWithEquipment++;
                }
            }
            
            // 更新顯示
            document.getElementById('totalEquipment').textContent = totalEquipment;
            document.getElementById('assignedEquipment').textContent = assignedEquipment;
            document.getElementById('availableEquipment').textContent = availableEquipment;
            document.getElementById('loanOutTotal').textContent = loanOutTotal;
            document.getElementById('loanInTotal').textContent = loanInTotal;
            document.getElementById('bedsWithEquipment').textContent = bedsWithEquipment;
        }

        // 添加床位配置变更监听
        window.addEventListener('storage', function(e) {
            if (e.key === 'bedConfig') {
                // 床位配置已更改，重新初始化床位网格
                initializeBedsGrid();
                
                // 重新加载设备到床位
                const savedData = localStorage.getItem('checklistData');
                if (savedData) {
                    const checklistData = JSON.parse(savedData);
                    if (checklistData.beds) {
                        checklistData.beds.forEach(bedData => {
                            const bedNumber = bedData.bedNumber;
                            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
                            if (equipmentList) {
                                // 清空现有设备
                                equipmentList.innerHTML = '';
                                
                                // 重新添加设备
                                bedData.equipment.forEach(eq => {
                                    // 创建设备标签
                                    const equipmentTag = document.createElement('div');
                                    equipmentTag.className = eq.isLoanIn ? 'bed-equipment-tag loan-in' : 'bed-equipment-tag';
                                    equipmentTag.dataset.name = eq.name;
                                    equipmentTag.dataset.number = eq.number;
                                    
                                    const nameSpan = document.createElement('span');
                                    nameSpan.textContent = eq.isLoanIn ? `${eq.name}${eq.number}號(借)` : `${eq.name}${eq.number}號`;
                                    
                                    const removeBtn = document.createElement('span');
                                    removeBtn.className = 'remove-btn';
                                    removeBtn.textContent = '×';
                                    removeBtn.addEventListener('click', function(e) {
                                        e.stopPropagation();
                                        removeEquipmentFromBed(removeBtn);
                                    });
                                    
                                    equipmentTag.appendChild(nameSpan);
                                    equipmentTag.appendChild(removeBtn);
                                    equipmentList.appendChild(equipmentTag);
                                });
                            }
                        });
                    }
                }
            }
        });

        // 显示借出/借入标签页
        function showLoanTab(tabType) {
            document.querySelectorAll('.loan-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.loan-content').forEach(content => content.classList.remove('active'));
            
            if (tabType === 'out') {
                document.querySelector('.loan-tab:first-child').classList.add('active');
                document.getElementById('loanOutContent').classList.add('active');
            } else {
                document.querySelector('.loan-tab:last-child').classList.add('active');
                document.getElementById('loanInContent').classList.add('active');
            }
        }
        
        // 初始化借出设备列表
        function initializeLoanOutItems() {
            const loanOutContainer = document.getElementById('loanOutItems');
            loanOutContainer.innerHTML = '';
            
            loanOutEquipment.forEach((item, index) => {
                const loanItem = document.createElement('div');
                loanItem.className = 'loan-item loan-out-item';
                loanItem.dataset.index = index;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${item.name} (${item.department})`;
                nameSpan.style.flex = '1';
                
                const countSpan = document.createElement('span');
                countSpan.className = 'inventory-count';
                countSpan.textContent = item.quantity;
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteLoanOutEquipment(index);
                });
                
                loanItem.appendChild(nameSpan);
                loanItem.appendChild(countSpan);
                loanItem.appendChild(deleteBtn);
                
                // 借出設備不能點選到床位，所以不添加點擊事件
                
                loanOutContainer.appendChild(loanItem);
            });
            
            // 更新統計數據
            updateStatistics();
        }
        
        // 初始化借入设备列表
        function initializeLoanInItems() {
            const loanInContainer = document.getElementById('loanInItems');
            loanInContainer.innerHTML = '';
            
            loanInEquipment.forEach((item, index) => {
                const loanItem = document.createElement('div');
                loanItem.className = 'loan-item loan-in-item';
                loanItem.dataset.index = index;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${item.name} (${item.source})`;
                nameSpan.style.flex = '1';
                
                const countSpan = document.createElement('span');
                countSpan.className = 'inventory-count';
                // 確保 count 和 available 屬性存在
                const count = item.count || 0;
                const available = item.available || 0;
                countSpan.textContent = `${available}/${count}`;
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteLoanInEquipment(index);
                });
                
                loanItem.appendChild(nameSpan);
                loanItem.appendChild(countSpan);
                loanItem.appendChild(deleteBtn);
                
                // 如果没有可用设备，禁用选择
                if (item.available <= 0) {
                    loanItem.classList.add('disabled');
                    loanItem.style.opacity = '0.5';
                    loanItem.style.cursor = 'not-allowed';
                } else {
                    loanItem.addEventListener('click', function() {
                        // 取消之前选中的设备
                        document.querySelectorAll('.loan-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 选中当前设备
                        this.classList.add('selected');
                        selectedLoanType = 'in';
                        selectedLoanEquipment = index;
                        
                        // 更新床位状态
                        updateBedButtonsStatus();
                    });
                }
                
                loanInContainer.appendChild(loanItem);
            });
            
            // 更新借入設備總數統計
            updateStatistics();
        }
        
        // 显示借出设备模态框
        function showLoanOutModal() {
            const select = document.getElementById('loanOutEquipment');
            select.innerHTML = '';
            
            // 添加可借出的设备选项
            defaultEquipment.forEach(item => {
                if (item.available > 0) {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = `${item.name} (可借出: ${item.available}台)`;
                    select.appendChild(option);
                }
            });
            
            if (select.options.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = '沒有可借出的設備';
                select.appendChild(option);
            }
            
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('loanOutModal').style.display = 'block';
        }
        
        // 显示借入设备模态框
        function showLoanInModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('loanInModal').style.display = 'block';
        }
        
        // 添加借出设备
        function addLoanOutEquipment() {
            const equipmentName = document.getElementById('loanOutEquipment').value;
            const quantity = parseInt(document.getElementById('loanOutQuantity').value) || 1;
            const department = document.getElementById('loanOutDepartment').value.trim();
            
            if (!equipmentName || !department) {
                showNotification('請填寫完整信息', 'error');
                return;
            }
            
            // 查找设备
            const equipment = defaultEquipment.find(e => e.name === equipmentName);
            if (!equipment || equipment.available < quantity) {
                showNotification('設備數量不足', 'error');
                return;
            }
            
            // 减少可用数量
            equipment.available -= quantity;
            
            // 添加到借出列表
            loanOutEquipment.push({
                name: equipmentName,
                quantity: quantity,
                department: department
            });
            
            // 更新UI
            initializeLoanOutItems();
            initializeEquipmentList();
            hideModal();
            showNotification('設備借出成功');
        }
        
        // 添加借入设备
        function addLoanInEquipment() {
            const nameInput = document.getElementById('loanInName');
            const sourceInput = document.getElementById('loanInDepartment');
            const countInput = document.getElementById('loanInQuantity');
            
            const name = nameInput.value.trim();
            const source = sourceInput.value.trim();
            const count = parseInt(countInput.value);
            
            if (!name || !source || isNaN(count) || count <= 0) {
                showNotification('請填寫完整的借入設備信息', 'error');
                return;
            }
            
            // 添加到借入設備列表
            loanInEquipment.push({
                name: name,
                source: source,
                count: count,
                available: count // 初始可用數量等於總數量
            });
            
            // 清空輸入框
            nameInput.value = '';
            sourceInput.value = '';
            countInput.value = '';
            
            // 更新借入設備列表顯示
            initializeLoanInItems();
            
            // 關閉模態框
            hideModal();
            
            // 顯示成功通知
            showNotification('借入設備已添加');
            
            // 立即更新統計數值
            updateStatistics();
        }
        
        // 删除借出设备
        function deleteLoanOutEquipment(index) {
            const loanItem = loanOutEquipment[index];
            
            // 恢复设备数量
            const equipment = defaultEquipment.find(e => e.name === loanItem.name);
            if (equipment) {
                equipment.available += loanItem.quantity;
            }
            
            // 从列表中删除
            loanOutEquipment.splice(index, 1);
            
            // 更新UI
            initializeLoanOutItems();
            initializeEquipmentList();
            showNotification('借出設備已刪除');
        }
        
        // 删除借入设备
        function deleteLoanInEquipment(index) {
            // 检查是否有借入设备已分配到床位
            const loanItem = loanInEquipment[index];
            let isAssigned = false;
            
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                const equipmentTags = equipmentList.querySelectorAll('.bed-equipment-tag');
                
                equipmentTags.forEach(tag => {
                    if (tag.dataset.name === loanItem.name && tag.classList.contains('loan-in')) {
                        isAssigned = true;
                    }
                });
                
                if (isAssigned) break;
            }
            
            if (isAssigned) {
                showNotification('此借入設備已分配到床位，無法刪除', 'error');
                return;
            }
            
            // 从列表中删除
            loanInEquipment.splice(index, 1);
            
            // 更新UI
            initializeLoanInItems();
            
            // 顯示通知
            showNotification('借入設備已刪除');
            
            // 更新統計數值
            updateStatistics();
        }

        // 更新日期和時間
        function updateDateTime() {
            const now = new Date();
            
            // 格式化日期：年/月/日 星期幾
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            const dateStr = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} 星期${days[now.getDay()]}`;
            
            // 格式化時間：時:分
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
        }

        // 頁面切換函數
        function navigateTo(page) {
            localStorage.setItem('currentPage', page);
            window.location.href = page;
        }

        // 添加借入設備到床位的函數
        function addLoanInEquipmentToBed(index, bedNumber) {
            const loanItem = loanInEquipment[index];
            
            // 檢查是否還有可用數量
            if (loanItem.available <= 0) {
                return;
            }
            
            // 獲取床位的設備列表
            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
            
            // 創建設備標籤
            const equipmentTag = document.createElement('div');
            equipmentTag.className = 'bed-equipment-tag loan-in';
            equipmentTag.textContent = loanItem.name;
            equipmentTag.dataset.name = loanItem.name;
            equipmentTag.dataset.source = loanItem.source;
            
            // 添加刪除按鈕
            const deleteButton = document.createElement('span');
            deleteButton.className = 'delete-equipment';
            deleteButton.textContent = '×';
            deleteButton.setAttribute('onclick', 'removeEquipmentFromBed(this)');
            
            equipmentTag.appendChild(deleteButton);
            equipmentList.appendChild(equipmentTag);
            
            // 減少借入設備的可用數量
            loanItem.available--;
            
            // 更新借入設備列表
            initializeLoanInItems();
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }

        // 添加借出設備到床位的函數
        function addLoanOutEquipmentToBed(name, bedNumber) {
            // 獲取床位的設備列表
            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
            
            // 檢查是否已經有相同的設備
            const existingTags = Array.from(equipmentList.querySelectorAll('.bed-equipment-tag'));
            const hasSameEquipment = existingTags.some(tag => 
                tag.dataset.name === name && tag.classList.contains('loan-out')
            );
            
            if (hasSameEquipment) {
                return;
            }
            
            // 創建設備標籤
            const equipmentTag = document.createElement('div');
            equipmentTag.className = 'bed-equipment-tag loan-out';
            equipmentTag.textContent = name;
            equipmentTag.dataset.name = name;
            
            // 添加刪除按鈕
            const deleteButton = document.createElement('span');
            deleteButton.className = 'delete-equipment';
            deleteButton.textContent = '×';
            deleteButton.setAttribute('onclick', 'removeEquipmentFromBed(this)');
            
            equipmentTag.appendChild(deleteButton);
            equipmentList.appendChild(equipmentTag);
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }
    </script>
</body>
</html> 