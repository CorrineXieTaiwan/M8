<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M8 護理排班系統 - 點班清單</title>
    <!-- 添加 Noto Sans TC 字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', "Microsoft JhengHei UI", "微軟正黑體", sans-serif;
            padding: 20px 20px 35px 20px;
            max-width: 1400px;
            margin: 0 auto;
            padding-bottom: 150px;
            transition: padding-bottom 0.3s ease;
        }
        * {
            font-family: 'Noto Sans TC', "Microsoft JhengHei UI", "微軟正黑體", sans-serif;
        }
        button,
        select,
        input,
        option {
            font-family: 'Noto Sans TC', "Microsoft JhengHei UI", "微軟正黑體", sans-serif;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        .nav-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .nav-button.active {
            background-color: #42a5f5;
            color: white;
        }
        .checklist-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex: 1;
            height: calc(100vh - 270px); /* 可以微調這個值 */
        }
        .equipment-list {
            width: 350px;
            height: 600px; /* 設定固定高度 */
            overflow-y: auto;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .equipment-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .equipment-item:hover {
            background-color: #e3f2fd;
        }
        .equipment-item.selected {
            background-color: #bbdefb;
            border-color: #42a5f5;
        }
        .equipment-item-count {
            background-color: #42a5f5;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            min-width: 40px;
            margin-right: 20px;
        }
        .beds-grid {
            flex: 1;
            height: 600px; /* 設定相同的固定高度 */
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            overflow-y: auto;
            padding: 15px; /* 增加內邊距 */
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .bed-cell {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 5px; /* 添加一點底部間距 */
            min-height: 140px;
            max-height: 140px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .bed-number {
            font-weight: bold;
            margin-bottom: 8px;
            color: #757575;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bed-label {
            color: #9e9e9e;
            font-size: 0.85em;
            font-weight: normal;
        }
        .bed-value {
            color: #2196f3;
            font-size: 1.2em;
            font-weight: 700;
            margin-left: auto;
        }
        .bed-equipment-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
            overflow-y: auto;
            flex: 1;
            padding-right: 4px;
        }
        .bed-equipment-tag {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 5px;
            margin: 0;
            min-height: 26px;
        }
        .bed-equipment-tag .delete-equipment {
            color: #f44336;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            margin-left: 5px;
            display: inline-block;
            padding: 0 4px;
            opacity: 1;
        }
        .bed-equipment-tag.loan-in {
            background-color: #fff8e1;
            border-color: #ffc107;
        }
        .bed-equipment-tag.loan-out {
            background-color: #ffebee;
            border-color: #f44336;
        }
        .search-bar {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 36px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .equipment-list-title {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2196f3;
        }
        .add-equipment-btn {
            margin-top: 10px;
            padding: 8px 12px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            width: 350px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-close {
            border: none;
            background: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        .action-buttons {
            position: fixed;
            bottom: 15px;
            right: 20px;
            z-index: 1000;
        }
        .floating-save-button {
            padding: 12px 24px;
            background-color: #FF9800;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            min-width: 300px;
            font-weight: 500;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .inventory-section {
            flex: 0 0 auto; /* 不要伸縮 */
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }
        .inventory-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .inventory-item {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            min-height: 36px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .inventory-item:hover {
            background-color: #bbdefb;
        }
        .inventory-item.selected {
            background-color: #90caf9;
            border-color: #42a5f5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .inventory-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        .inventory-count {
            background-color: #42a5f5;
            color: white;
            border-radius: 4px;
            padding: 3px 8px;
            min-width: 50px;
            text-align: center;
            flex-shrink: 0;
            font-weight: bold;
        }
        .equipment-item .delete-btn {
            position: absolute;
            right: 10px;
            color: #f44336;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .equipment-item:hover .delete-btn {
            opacity: 1;
        }
        .main-content {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 190px); /* 可以微調這個值 */
            padding-bottom: 20px;
        }
        .stats-bar {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.6em;
            font-weight: 700;
            color: #2196f3;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            color: #666;
        }
        .stat-card {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .stat-card.total .stat-value {
            color: #2196f3;
        }
        .stat-card.assigned .stat-value {
            color: #ff9800;
        }
        .stat-card.available .stat-value {
            color: #4caf50;
        }
        .stat-card.loan-out .stat-value {
            color: #f44336;
        }
        .stat-card.loan-in .stat-value {
            color: #9c27b0;
        }
        .stat-card.beds .stat-value {
            color: #607d8b;
        }
        .loan-section {
            flex: 0 0 auto; /* 不要伸縮 */
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        .loan-tabs {
            display: flex;
            margin-bottom: 10px;
        }
        
        .loan-tab {
            padding: 8px 16px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            flex: 1;
            text-align: center;
        }
        
        .loan-tab.active {
            background-color: #42a5f5;
            color: white;
        }
        
        .loan-tab:first-child {
            border-radius: 4px 0 0 4px;
        }
        
        .loan-tab:last-child {
            border-radius: 0 4px 4px 0;
        }
        
        .loan-content {
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .loan-content.active {
            display: block;
        }
        
        .loan-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .loan-item:hover {
            background-color: #e3f2fd;
        }
        
        .loan-item.selected {
            background-color: #bbdefb;
            border-color: #42a5f5;
        }
        
        .loan-out-item {
            border-left: 4px solid #f44336;
        }
        
        .loan-in-item {
            border-left: 4px solid #ffc107;
        }
        
        .inventory-count {
            background-color: #42a5f5;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            min-width: 40px;
            text-align: center;
        }
        
        .bed-equipment-tag.loan-out {
            background-color: #ffebee;
            border-color: #f44336;
        }
        
        .bed-equipment-tag.loan-in {
            background-color: #fff8e1;
            border-color: #ffc107;
        }
        .title-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            position: relative;
            width: 100%;
            min-width: 1000px;
            padding: 0 20px;
        }
        .title-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }
        .title-right {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-shrink: 0;
        }
        .head-nurse {
            font-size: 1.5rem;
            color: #2196f3;
            font-weight: 500;
            white-space: nowrap;
            border-left: 2px solid #90caf9;
            padding-left: 20px;
        }
        .hospital-logo {
            height: 50px;
            width: auto;
            object-fit: contain;
        }
        .datetime-display {
            text-align: right;
            color: #333;
            min-width: 220px;
            white-space: nowrap;
        }
        .datetime-line {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 30px;
        }
        #currentDate {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }
        #currentTime {
            font-size: 1.6rem;
            font-weight: 700;
            color: #333;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        .action-button {
            padding: 8px 16px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .action-button:hover {
            background-color: #1976d2;
        }
        .bottom-nav-buttons {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 900;
        }
        
        .modal {
            width: 350px;
        }
        
        .modal-form-group {
            margin-bottom: 15px;
        }
        
        .modal-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .modal-form-group input,
        .modal-form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            height: 36px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-button {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            border: none;
        }
        
        .modal-button.cancel {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .modal-button.submit {
            background-color: #4caf50;
            color: white;
        }
        
        .modal-button.loan-out {
            background-color: #f44336;
            color: white;
        }
        
        .modal-button.loan-in {
            background-color: #ffc107;
            color: white;
        }

        .equipment-list::-webkit-scrollbar,
        .beds-grid::-webkit-scrollbar {
            width: 6px;
        }

        .equipment-list::-webkit-scrollbar-track,
        .beds-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
            margin: 5px;
        }

        .equipment-list::-webkit-scrollbar-thumb,
        .beds-grid::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .equipment-list::-webkit-scrollbar-thumb:hover,
        .beds-grid::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        .inventory-grid {
            max-height: 200px;
            overflow-y: auto;
        }

        .loan-content {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title-container">
            <div class="title-left">
                <h1>M8 設備點班系統</h1>
                <span class="head-nurse">病房護理長：鐘黛瑩</span>
            </div>
            <div class="title-right">
                <div class="datetime-display">
                    <div class="datetime-line">
                        <span id="currentDate"></span>
                        <span id="currentTime"></span>
                    </div>
                </div>
                <img src="images/Chung_Shan_Medical_University_seal.svg.png" alt="中山醫學大學附設醫院" class="hospital-logo">
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalEquipment">0</div>
                <div class="stat-label">設備總數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="assignedEquipment">0</div>
                <div class="stat-label">已分配設備</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="availableEquipment">0</div>
                <div class="stat-label">可用設備</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="loanOutTotal">0</div>
                <div class="stat-label">借出總數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="loanInTotal">0</div>
                <div class="stat-label">借入總數</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bedsWithEquipment">0</div>
                <div class="stat-label">已配置床號</div>
            </div>
        </div>

        <div class="checklist-container">
            <div class="equipment-list">
                <div class="inventory-section">
                    <div class="inventory-title">
                        <h3 class="equipment-list-title">單位庫存區域</h3>
                    </div>
                    <div class="inventory-grid" id="inventoryGrid">
                        <!-- 库存项目将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <div class="loan-section">
                    <div class="loan-tabs">
                        <button class="loan-tab active" onclick="showLoanTab('out')">借出區</button>
                        <button class="loan-tab" onclick="showLoanTab('in')">借入區</button>
                    </div>
                    <div class="loan-content active" id="loanOutContent">
                        <!-- 借出设备列表 -->
                        <div id="loanOutItems"></div>
                        <button class="add-equipment-btn" style="margin-top: 10px;" onclick="showLoanOutModal()">新增借出設備</button>
                    </div>
                    <div class="loan-content" id="loanInContent">
                        <!-- 借入设备列表 -->
                        <div id="loanInItems"></div>
                        <button class="add-equipment-btn" style="margin-top: 10px;" onclick="showLoanInModal()">新增借入設備</button>
                    </div>
                </div>
                
                <h3 class="equipment-list-title" style="margin-top: 20px;">單位設備清單</h3>
                <div class="search-bar">
                    <input type="text" id="equipmentSearch" placeholder="搜尋設備..." oninput="filterEquipment()">
                </div>
                <div id="equipmentItems">
                    <!-- 设备项目将通过JavaScript动态生成 -->
                </div>
                <button class="add-equipment-btn" style="margin-top: 10px;" onclick="showAddEquipmentModal()">新增單位設備</button>
            </div>
            
            <div class="beds-grid" id="bedsGrid">
                <!-- 床位格子将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 添加设备的模态框 -->
    <div class="modal-backdrop" id="modalBackdrop"></div>
    <div class="modal" id="equipmentModal">
        <div class="modal-header">
            <h3>新增設備</h3>
            <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="modal-form-group">
                <label for="newEquipmentInput">設備名稱</label>
                <input type="text" id="newEquipmentInput" placeholder="輸入設備名稱">
            </div>
            <div class="modal-form-group">
                <label for="newEquipmentTotal">設備數量</label>
                <input type="number" id="newEquipmentTotal" value="1" min="1">
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel" onclick="hideModal()">取消</button>
                <button class="modal-button submit" onclick="addNewEquipment()">新增</button>
            </div>
        </div>
    </div>

    <!-- 添加借出/借入设备的模态框 -->
    <div class="modal" id="loanOutModal">
        <div class="modal-header">
            <h3>新增借出設備</h3>
            <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="modal-form-group">
                <label for="loanOutEquipment">設備名稱</label>
                <select id="loanOutEquipment">
                    <!-- 选项将通过JavaScript动态生成 -->
                </select>
            </div>
            <div class="modal-form-group">
                <label for="loanOutQuantity">借出數量</label>
                <input type="number" id="loanOutQuantity" value="1" min="1">
            </div>
            <div class="modal-form-group">
                <label for="loanOutDepartment">借出單位</label>
                <input type="text" id="loanOutDepartment" placeholder="輸入借出單位">
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel" onclick="hideModal()">取消</button>
                <button class="modal-button loan-out" onclick="addLoanOutEquipment()">新增借出</button>
            </div>
        </div>
    </div>

    <div class="modal" id="loanInModal">
        <div class="modal-header">
            <h3>新增借入設備</h3>
            <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-content">
            <div class="modal-form-group">
                <label for="loanInName">設備名稱</label>
                <input type="text" id="loanInName" placeholder="輸入設備名稱">
            </div>
            <div class="modal-form-group">
                <label for="loanInQuantity">借入數量</label>
                <input type="number" id="loanInQuantity" value="1" min="1">
            </div>
            <div class="modal-form-group">
                <label for="loanInDepartment">借入單位</label>
                <input type="text" id="loanInDepartment" placeholder="輸入借入單位">
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel" onclick="hideModal()">取消</button>
                <button class="modal-button loan-in" onclick="addLoanInEquipment()">新增借入</button>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="floating-save-button" onclick="saveChecklistData()">保存點班</button>
    </div>

    <div class="notification" id="notification"></div>

    <!-- 添加共享导航脚本 -->
    <script src="js/shared-navigation.js"></script>

    <script>
        // 修改预设设备列表
        const defaultEquipment = [
            { name: "IV Pump", total: 10, available: 10 },
            { name: "血氧機", total: 10, available: 10 },
            { name: "氧氣筒", total: 10, available: 10 },
            { name: "烤燈", total: 1, available: 1 },
            { name: "小床", total: 2, available: 2 },
            { name: "床磅", total: 1, available: 1 }
        ];

        // 设备使用记录
        let equipmentUsage = {};
        
        // 当前选中的设备
        let selectedEquipment = null;
        
        // 添加借出/借入设备数据
        let loanOutEquipment = [];
        let loanInEquipment = [];
        
        // 当前选中的借出/借入设备
        let selectedLoanType = null;
        let selectedLoanEquipment = null;
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 設置當前頁面標識
            localStorage.setItem('currentPage', 'checklist.html');
            
            // 更新標題
            document.querySelector('.title-container h1').textContent = 'M8 設備點班系統';
            
            initializeEquipmentList();
            initializeBedsGrid();
            initializeLoanOutItems();
            initializeLoanInItems();
            loadChecklistData();
            
            // 确保所有模态框的关闭按钮都绑定了hideModal函数
            document.querySelectorAll('.modal-close').forEach(button => {
                button.onclick = hideModal;
            });
            
            // 初始化日期時間
            updateDateTime();
            
            // 每分鐘更新一次
            setInterval(updateDateTime, 60000);
        });

        // 初始化设备列表
        function initializeEquipmentList() {
            const equipmentContainer = document.getElementById('equipmentItems');
            equipmentContainer.innerHTML = '';
            
            defaultEquipment.forEach(item => {
                const equipmentDiv = document.createElement('div');
                equipmentDiv.className = 'equipment-item';
                equipmentDiv.dataset.name = item.name;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = item.name;
                nameSpan.style.flex = '1';
                
                const countSpan = document.createElement('span');
                countSpan.className = 'equipment-item-count';
                countSpan.textContent = `${item.available}/${item.total}`;
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteEquipment(item.name);
                });
                
                equipmentDiv.appendChild(nameSpan);
                equipmentDiv.appendChild(countSpan);
                equipmentDiv.appendChild(deleteBtn);
                
                // 如果没有可用设备，禁用选择
                if (item.available <= 0) {
                    equipmentDiv.classList.add('disabled');
                    equipmentDiv.style.opacity = '0.5';
                    equipmentDiv.style.cursor = 'not-allowed';
                } else {
                    equipmentDiv.addEventListener('click', function() {
                        // 取消之前选中的设备
                        document.querySelectorAll('.equipment-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 取消借入设备的选中状态
                        document.querySelectorAll('.loan-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 取消库存项的选中状态
                        document.querySelectorAll('.inventory-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 选中当前设备
                        this.classList.add('selected');
                        
                        // 同时选中对应的库存项
                        const inventoryItem = document.querySelector(`.inventory-item[data-name="${this.dataset.name}"]`);
                        if (inventoryItem) {
                            inventoryItem.classList.add('selected');
                        }
                        
                        selectedEquipment = this.dataset.name;
                        
                        // 清除借入设备的选择
                        selectedLoanType = null;
                        selectedLoanEquipment = null;
                    });
                }
                
                equipmentContainer.appendChild(equipmentDiv);
            });
            
            // 更新库存区域
            updateInventoryGrid();
            
            // 更新统计数据
            updateStatistics();
        }

        // 修改初始化床位網格函數，保留原有視覺設計
        function initializeBedsGrid() {
            const bedsGrid = document.getElementById('bedsGrid');
            bedsGrid.innerHTML = '';
            
            // 獲取床號配置和總床位數量
            let bedConfig = JSON.parse(localStorage.getItem('bedConfig')) || {};
            const savedTotalBeds = parseInt(localStorage.getItem('totalBeds')) || 36;
            
            for (let i = 1; i <= savedTotalBeds; i++) {
                const bedCell = document.createElement('div');
                bedCell.className = 'bed-cell';
                
                const bedNumber = document.createElement('div');
                bedNumber.className = 'bed-number';
                
                // 創建床號標籤（"床號"文字）
                const bedLabel = document.createElement('span');
                bedLabel.className = 'bed-label';
                bedLabel.textContent = '床號';
                
                // 創建床號數字
                const bedValue = document.createElement('span');
                bedValue.className = 'bed-value';
                
                // 使用自定義名稱或默認名稱
                const bedId = `bed_${i-1}`;
                const displayName = bedConfig[bedId] || i.toString();
                bedValue.textContent = displayName;
                
                // 組裝床號區域
                bedNumber.appendChild(bedLabel);
                bedNumber.appendChild(bedValue);
                
                const equipmentList = document.createElement('div');
                equipmentList.className = 'bed-equipment-list';
                equipmentList.dataset.bedNumber = i;
                
                bedCell.appendChild(bedNumber);
                bedCell.appendChild(equipmentList);
                
                // 添加點擊事件
                bedCell.addEventListener('click', function() {
                    if (selectedEquipment) {
                        addEquipmentToBed(selectedEquipment, i);
                    } else if (selectedLoanType === 'in' && selectedLoanEquipment !== null) {
                        addLoanInEquipmentToBed(selectedLoanEquipment, i);
                    }
                });
                
                bedsGrid.appendChild(bedCell);
            }
        }

        // 添加設備到床位
        function addEquipmentToBed(equipmentName, bedNumber) {
            // 查找設備
            const equipment = defaultEquipment.find(e => e.name === equipmentName);
            
            // 檢查是否還有可用數量
            if (!equipment || equipment.available <= 0) {
                return;
            }
            
            // 獲取床位的設備列表
            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
            
            // 創建設備標籤容器
            const equipmentTag = document.createElement('div');
            equipmentTag.className = 'bed-equipment-tag';
            equipmentTag.dataset.name = equipmentName;
            
            // 創建名稱容器
            const nameContainer = document.createElement('span');
            nameContainer.className = 'equipment-name';
            nameContainer.textContent = equipmentName;
            
            // 創建刪除按鈕
            const deleteButton = document.createElement('span');
            deleteButton.className = 'delete-equipment';
            deleteButton.innerHTML = '×';
            deleteButton.onclick = function(e) {
                e.stopPropagation();
                removeEquipmentFromBed(this);
            };
            
            // 組裝元素
            equipmentTag.appendChild(nameContainer);
            equipmentTag.appendChild(deleteButton);
            equipmentList.appendChild(equipmentTag);
            
            // 減少設備的可用數量
            equipment.available--;
            
            // 更新設備列表
            initializeEquipmentList();
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }

        // 從床位移除設備
        function removeEquipmentFromBed(deleteButton) {
            // 獲取整個設備標籤元素（父元素）
            const equipmentTag = deleteButton.closest('.bed-equipment-tag');
            if (!equipmentTag) return;

            const equipmentName = equipmentTag.dataset.name;
            const isLoanIn = equipmentTag.classList.contains('loan-in');
            const isLoanOut = equipmentTag.classList.contains('loan-out');
            
            if (isLoanIn) {
                // 處理借入設備
                const loanItem = loanInEquipment.find(item => item.name === equipmentName);
                if (loanItem) {
                    loanItem.available++;
                    initializeLoanInItems();
                }
            } else if (!isLoanOut) {
                // 處理普通設備
                const equipment = defaultEquipment.find(e => e.name === equipmentName);
                if (equipment) {
                    equipment.available++;
                    initializeEquipmentList();
                }
            }
            
            // 移除整個設備標籤
            equipmentTag.remove();
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }

        // 更新库存区域
        function updateInventoryGrid() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = '';
            
            // 只显示有库存的设备
            defaultEquipment.forEach(item => {
                // 创建库存项
                const inventoryItem = document.createElement('div');
                inventoryItem.className = 'inventory-item';
                inventoryItem.dataset.name = item.name; // 添加数据属性以便识别
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'inventory-item-name';
                nameSpan.textContent = item.name;
                nameSpan.title = item.name; // 添加悬停提示，显示完整名称
                
                const countSpan = document.createElement('span');
                countSpan.className = 'inventory-count';
                countSpan.textContent = `${item.available}/${item.total}`;
                
                // 如果没有可用设备，显示灰色
                if (item.available <= 0) {
                    inventoryItem.style.opacity = '0.5';
                    countSpan.style.backgroundColor = '#999';
                }
                
                inventoryItem.appendChild(nameSpan);
                inventoryItem.appendChild(countSpan);
                
                // 点击库存项也可以选择设备
                inventoryItem.addEventListener('click', function() {
                    if (item.available > 0) {
                        // 取消借入设备的选中状态
                        document.querySelectorAll('.loan-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 取消所有设备项的选中状态
                        document.querySelectorAll('.equipment-item').forEach(elem => {
                            elem.classList.remove('selected');
                        });
                        
                        // 取消所有库存项的选中状态
                        document.querySelectorAll('.inventory-item').forEach(elem => {
                            elem.classList.remove('selected');
                        });
                        
                        // 选中当前库存项
                        this.classList.add('selected');
                        
                        // 同时选中对应的设备项
                        const equipmentItem = document.querySelector(`.equipment-item[data-name="${item.name}"]`);
                        if (equipmentItem) {
                            equipmentItem.classList.add('selected');
                        }
                        
                        selectedEquipment = item.name;
                        
                        // 清除借入设备的选择
                        selectedLoanType = null;
                        selectedLoanEquipment = null;
                    }
                });
                
                inventoryGrid.appendChild(inventoryItem);
            });
        }

        // 过滤设备列表
        function filterEquipment() {
            const searchText = document.getElementById('equipmentSearch').value.toLowerCase();
            const equipmentItems = document.querySelectorAll('.equipment-item');
            
            equipmentItems.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                if (name.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // 显示添加设备的模态框
        function showAddEquipmentModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('equipmentModal').style.display = 'block';
            document.getElementById('newEquipmentInput').focus();
        }

        // 修改隐藏模态框函数
        function hideModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
            document.getElementById('equipmentModal').style.display = 'none';
            document.getElementById('loanOutModal').style.display = 'none';
            document.getElementById('loanInModal').style.display = 'none';
            
            // 清空输入框
            if (document.getElementById('newEquipmentInput')) {
                document.getElementById('newEquipmentInput').value = '';
            }
            if (document.getElementById('loanInName')) {
                document.getElementById('loanInName').value = '';
            }
            if (document.getElementById('loanInDepartment')) {
                document.getElementById('loanInDepartment').value = '';
            }
            if (document.getElementById('loanOutDepartment')) {
                document.getElementById('loanOutDepartment').value = '';
            }
        }

        // 添加新设备
        function addNewEquipment() {
            const input = document.getElementById('newEquipmentInput');
            const name = input.value.trim();
            const totalInput = document.getElementById('newEquipmentTotal');
            const total = parseInt(totalInput.value) || 1;
            
            if (name) {
                // 检查是否已存在
                const existingEquipment = defaultEquipment.find(e => e.name === name);
                if (existingEquipment) {
                    showNotification('此設備已存在！', 'error');
                    return;
                }
                
                // 添加新设备
                defaultEquipment.push({
                    name: name,
                    total: total,
                    available: total
                });
                
                initializeEquipmentList();
                hideModal();
                showNotification('新設備已添加！');
            }
        }

        // 加載點班數據
        function loadChecklistData() {
            const savedData = localStorage.getItem('checklistData');
            if (savedData) {
                const data = JSON.parse(savedData);
                
                // 恢復設備列表
                if (data.equipment) {
                    // 更新默認設備列表
                    for (let i = 0; i < defaultEquipment.length; i++) {
                        if (i < data.equipment.length) {
                            defaultEquipment[i].total = data.equipment[i].total;
                            defaultEquipment[i].available = data.equipment[i].available;
                        }
                    }
                    
                    // 添加新增的設備
                    for (let i = defaultEquipment.length; i < data.equipment.length; i++) {
                        defaultEquipment.push(data.equipment[i]);
                    }
                }
                
                // 恢復借出設備列表
                if (data.loanOut) {
                    loanOutEquipment = data.loanOut;
                }
                
                // 恢復借入設備列表
                if (data.loanIn) {
                    loanInEquipment = data.loanIn;
                }
                
                // 恢復床位設備分配
                if (data.beds) {
                    for (let bedNumber in data.beds) {
                        const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
                        if (equipmentList) {
                            // 清空現有設備
                            equipmentList.innerHTML = '';
                            
                            // 添加保存的設備
                            data.beds[bedNumber].forEach(item => {
                                const equipmentTag = document.createElement('div');
                                equipmentTag.className = `bed-equipment-tag ${item.type || ''}`;
                                equipmentTag.textContent = item.name;
                                equipmentTag.dataset.name = item.name;
                                
                                if (item.source) {
                                    equipmentTag.dataset.source = item.source;
                                }
                                
                                // 添加刪除按鈕
                                const deleteButton = document.createElement('span');
                                deleteButton.className = 'delete-equipment';
                                deleteButton.textContent = '×';
                                deleteButton.setAttribute('onclick', 'removeEquipmentFromBed(this)');
                                
                                equipmentTag.appendChild(deleteButton);
                                equipmentList.appendChild(equipmentTag);
                            });
                        }
                    }
                }
                
                // 更新設備列表和統計數據
                initializeEquipmentList();
                initializeLoanOutItems();
                initializeLoanInItems();
                updateStatistics();
            }
        }
        
        // 保存點班數據
        function saveChecklistData() {
            // 創建要保存的數據對象
            const checklistData = {
                equipment: defaultEquipment,
                loanOut: loanOutEquipment,
                loanIn: loanInEquipment,
                beds: {}
            };
            
            // 獲取實際的床位數量
            const savedTotalBeds = parseInt(localStorage.getItem('totalBeds')) || 36;
            
            // 收集床位設備分配
            for (let i = 1; i <= savedTotalBeds; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList) {  // 確保元素存在
                    const equipmentTags = equipmentList.querySelectorAll('.bed-equipment-tag');
                    
                    if (equipmentTags.length > 0) {
                        checklistData.beds[i] = [];
                        
                        equipmentTags.forEach(tag => {
                            const equipmentData = {
                                name: tag.dataset.name,
                                type: tag.classList.contains('loan-in') ? 'loan-in' : 
                                      tag.classList.contains('loan-out') ? 'loan-out' : ''
                            };
                            
                            if (tag.dataset.source) {
                                equipmentData.source = tag.dataset.source;
                            }
                            
                            checklistData.beds[i].push(equipmentData);
                        });
                    }
                }
            }
            
            // 保存到localStorage
            localStorage.setItem('checklistData', JSON.stringify(checklistData));
            
            // 顯示成功通知
            showNotification('點班數據已保存');
        }

        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            // 根據不同類型設置不同的樣式
            if (type === 'error') {
                notification.style.backgroundColor = '#ff4d4f';
                notification.style.borderLeft = '5px solid #f5222d';
            } else {
                notification.style.backgroundColor = '#52c41a';
                notification.style.borderLeft = '5px solid #389e0d';
            }
            
            notification.classList.add('show');
            
            // 3秒後自動隱藏
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 添加按Enter键提交功能
        document.getElementById('newEquipmentInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewEquipment();
            }
        });

        // 完善删除设备功能，添加防呆机制
        function deleteEquipment(equipmentName) {
            console.log("嘗試刪除設備:", equipmentName);
            
            // 1. 首先檢查是否有未歸還的借出設備
            const hasLoanedOut = loanOutEquipment.some(item => item.name === equipmentName);
            if (hasLoanedOut) {
                showNotification('此設備尚有借出未歸還，請先處理借出設備後再進行刪除', 'error');
                return;
            }

            // 2. 檢查設備是否已分配到床位
            let isAssigned = false;
            const savedTotalBeds = parseInt(localStorage.getItem('totalBeds')) || 36;
            
            for (let i = 1; i <= savedTotalBeds; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList) {
                    const equipmentTags = equipmentList.querySelectorAll('.bed-equipment-tag');
                    equipmentTags.forEach(tag => {
                        if (tag.dataset.name === equipmentName) {
                            isAssigned = true;
                        }
                    });
                }
                if (isAssigned) break;
            }
            
            // 3. 如果設備已分配到床位，顯示錯誤提示
            if (isAssigned) {
                showNotification('此設備使用中，無法進行變更', 'error');
                return;
            }
            
            // 4. 如果通過所有檢查，詢問確認刪除
            if (confirm(`確定要刪除「${equipmentName}」設備嗎？此操作無法恢復。`)) {
                // 從設備列表中刪除
                const index = defaultEquipment.findIndex(e => e.name === equipmentName);
                if (index !== -1) {
                    defaultEquipment.splice(index, 1);
                    initializeEquipmentList();
                    showNotification('設備已刪除');
                    saveChecklistData();
                }
            }
        }

        // 更新统计数据
        function updateStatistics() {
            // 計算設備總數 (只計算原始庫存，不包括借入設備)
            let totalEquipment = defaultEquipment.reduce((sum, item) => sum + item.total, 0);
            
            // 計算已分配設備
            let assignedEquipment = 0;
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList) {
                    // 只計算原始庫存設備和借出設備，不計算借入設備
                    const regularTags = equipmentList.querySelectorAll('.bed-equipment-tag:not(.loan-in)');
                    assignedEquipment += regularTags.length;
                }
            }
            
            // 計算可用設備 (只計算原始庫存，不包括借入設備)
            const availableEquipment = defaultEquipment.reduce((sum, item) => sum + item.available, 0);
            
            // 計算借出總數
            const loanOutTotal = loanOutEquipment.reduce((sum, item) => sum + item.quantity, 0);
            
            // 計算借入總數
            const loanInTotal = loanInEquipment.reduce((sum, item) => sum + item.count, 0);
            
            // 計算已配置床號數
            let bedsWithEquipment = 0;
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                if (equipmentList && equipmentList.querySelectorAll('.bed-equipment-tag').length > 0) {
                    bedsWithEquipment++;
                }
            }
            
            // 更新顯示
            document.getElementById('totalEquipment').textContent = totalEquipment;
            document.getElementById('assignedEquipment').textContent = assignedEquipment;
            document.getElementById('availableEquipment').textContent = availableEquipment;
            document.getElementById('loanOutTotal').textContent = loanOutTotal;
            document.getElementById('loanInTotal').textContent = loanInTotal;
            document.getElementById('bedsWithEquipment').textContent = bedsWithEquipment;
        }

        // 添加床位配置变更监听
        window.addEventListener('storage', function(e) {
            if (e.key === 'bedConfig') {
                // 床位配置已更改，重新初始化床位网格
                initializeBedsGrid();
                
                // 重新加载设备到床位
                const savedData = localStorage.getItem('checklistData');
                if (savedData) {
                    const checklistData = JSON.parse(savedData);
                    if (checklistData.beds) {
                        checklistData.beds.forEach(bedData => {
                            const bedNumber = bedData.bedNumber;
                            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
                            if (equipmentList) {
                                // 清空现有设备
                                equipmentList.innerHTML = '';
                                
                                // 重新添加设备
                                bedData.equipment.forEach(eq => {
                                    // 创建设备标签
                                    const equipmentTag = document.createElement('div');
                                    equipmentTag.className = eq.isLoanIn ? 'bed-equipment-tag loan-in' : 'bed-equipment-tag';
                                    equipmentTag.dataset.name = eq.name;
                                    equipmentTag.dataset.number = eq.number;
                                    
                                    const nameSpan = document.createElement('span');
                                    nameSpan.textContent = eq.isLoanIn ? `${eq.name}${eq.number}號(借)` : `${eq.name}${eq.number}號`;
                                    
                                    const removeBtn = document.createElement('span');
                                    removeBtn.className = 'remove-btn';
                                    removeBtn.textContent = '×';
                                    removeBtn.addEventListener('click', function(e) {
                                        e.stopPropagation();
                                        removeEquipmentFromBed(removeBtn);
                                    });
                                    
                                    equipmentTag.appendChild(nameSpan);
                                    equipmentTag.appendChild(removeBtn);
                                    equipmentList.appendChild(equipmentTag);
                                });
                            }
                        });
                    }
                }
            }
        });

        // 显示借出/借入标签页
        function showLoanTab(tabType) {
            document.querySelectorAll('.loan-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.loan-content').forEach(content => content.classList.remove('active'));
            
            if (tabType === 'out') {
                document.querySelector('.loan-tab:first-child').classList.add('active');
                document.getElementById('loanOutContent').classList.add('active');
            } else {
                document.querySelector('.loan-tab:last-child').classList.add('active');
                document.getElementById('loanInContent').classList.add('active');
            }
        }
        
        // 初始化借出设备列表
        function initializeLoanOutItems() {
            const loanOutContainer = document.getElementById('loanOutItems');
            loanOutContainer.innerHTML = '';
            
            loanOutEquipment.forEach((item, index) => {
                const loanItem = document.createElement('div');
                loanItem.className = 'loan-item loan-out-item';
                loanItem.dataset.index = index;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${item.name} (${item.department})`;
                nameSpan.style.flex = '1';
                
                const countSpan = document.createElement('span');
                countSpan.className = 'inventory-count';
                countSpan.textContent = item.quantity;
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteLoanOutEquipment(index);
                });
                
                loanItem.appendChild(nameSpan);
                loanItem.appendChild(countSpan);
                loanItem.appendChild(deleteBtn);
                
                // 借出設備不能點選到床位，所以不添加點擊事件
                
                loanOutContainer.appendChild(loanItem);
            });
            
            // 更新統計數據
            updateStatistics();
        }
        
        // 初始化借入设备列表
        function initializeLoanInItems() {
            const loanInContainer = document.getElementById('loanInItems');
            loanInContainer.innerHTML = '';
            
            loanInEquipment.forEach((item, index) => {
                const loanItem = document.createElement('div');
                loanItem.className = 'loan-item loan-in-item';
                loanItem.dataset.index = index;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = `${item.name} (${item.source})`;
                nameSpan.style.flex = '1';
                
                const countSpan = document.createElement('span');
                countSpan.className = 'inventory-count';
                // 確保 count 和 available 屬性存在
                const count = item.count || 0;
                const available = item.available || 0;
                countSpan.textContent = `${available}/${count}`;
                
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteLoanInEquipment(index);
                });
                
                loanItem.appendChild(nameSpan);
                loanItem.appendChild(countSpan);
                loanItem.appendChild(deleteBtn);
                
                // 如果没有可用设备，禁用选择
                if (item.available <= 0) {
                    loanItem.classList.add('disabled');
                    loanItem.style.opacity = '0.5';
                    loanItem.style.cursor = 'not-allowed';
                } else {
                    loanItem.addEventListener('click', function() {
                        // 取消之前选中的设备
                        document.querySelectorAll('.loan-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 取消单位设备的选中状态
                        document.querySelectorAll('.equipment-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 取消库存项的选中状态
                        document.querySelectorAll('.inventory-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // 选中当前设备
                        this.classList.add('selected');
                        selectedLoanType = 'in';
                        selectedLoanEquipment = index;
                        
                        // 清除单位设备的选择
                        selectedEquipment = null;
                    });
                }
                
                loanInContainer.appendChild(loanItem);
            });
            
            // 更新借入設備總數統計
            updateStatistics();
        }
        
        // 显示借出设备模态框
        function showLoanOutModal() {
            const select = document.getElementById('loanOutEquipment');
            select.innerHTML = '';
            
            // 添加可借出的设备选项
            defaultEquipment.forEach(item => {
                if (item.available > 0) {
                    const option = document.createElement('option');
                    option.value = item.name;
                    option.textContent = `${item.name} (可借出: ${item.available}台)`;
                    select.appendChild(option);
                }
            });
            
            if (select.options.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = '沒有可借出的設備';
                select.appendChild(option);
            }
            
            // 重置借出數量為1
            document.getElementById('loanOutQuantity').value = '1';
            
            // 清空借出單位輸入框
            document.getElementById('loanOutDepartment').value = '';
            
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('loanOutModal').style.display = 'block';
        }
        
        // 显示借入设备模态框
        function showLoanInModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('loanInModal').style.display = 'block';
        }
        
        // 添加借出设备
        function addLoanOutEquipment() {
            const equipmentName = document.getElementById('loanOutEquipment').value;
            const quantity = parseInt(document.getElementById('loanOutQuantity').value) || 1;
            const department = document.getElementById('loanOutDepartment').value.trim();
            
            if (!equipmentName || !department) {
                showNotification('請填寫完整信息', 'error');
                return;
            }
            
            // 查找设备
            const equipment = defaultEquipment.find(e => e.name === equipmentName);
            if (!equipment || equipment.available < quantity) {
                showNotification('設備數量不足', 'error');
                return;
            }
            
            // 减少可用数量
            equipment.available -= quantity;
            
            // 添加到借出列表
            loanOutEquipment.push({
                name: equipmentName,
                quantity: quantity,
                department: department
            });
            
            // 更新UI
            initializeLoanOutItems();
            initializeEquipmentList();
            hideModal();
            showNotification('設備借出成功');
        }
        
        // 添加借入设备
        function addLoanInEquipment() {
            const nameInput = document.getElementById('loanInName');
            const sourceInput = document.getElementById('loanInDepartment');
            const countInput = document.getElementById('loanInQuantity');
            
            const name = nameInput.value.trim();
            const source = sourceInput.value.trim();
            const count = parseInt(countInput.value);
            
            if (!name || !source || isNaN(count) || count <= 0) {
                showNotification('請填寫完整的借入設備信息', 'error');
                return;
            }
            
            // 添加到借入設備列表
            loanInEquipment.push({
                name: name,
                source: source,
                count: count,
                available: count // 初始可用數量等於總數量
            });
            
            // 清空輸入框
            nameInput.value = '';
            sourceInput.value = '';
            countInput.value = '';
            
            // 更新借入設備列表顯示
            initializeLoanInItems();
            
            // 關閉模態框
            hideModal();
            
            // 顯示成功通知
            showNotification('借入設備已添加');
            
            // 立即更新統計數值
            updateStatistics();
        }
        
        // 删除借出设备
        function deleteLoanOutEquipment(index) {
            const loanItem = loanOutEquipment[index];
            
            // 恢复设备数量
            const equipment = defaultEquipment.find(e => e.name === loanItem.name);
            if (equipment) {
                equipment.available += loanItem.quantity;
            }
            
            // 从列表中删除
            loanOutEquipment.splice(index, 1);
            
            // 更新UI
            initializeLoanOutItems();
            initializeEquipmentList();
            showNotification('借出設備已歸還');
        }
        
        // 删除借入设备
        function deleteLoanInEquipment(index) {
            // 检查是否有借入设备已分配到床位
            const loanItem = loanInEquipment[index];
            let isAssigned = false;
            
            for (let i = 1; i <= 36; i++) {
                const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${i}"]`);
                const equipmentTags = equipmentList.querySelectorAll('.bed-equipment-tag');
                
                equipmentTags.forEach(tag => {
                    if (tag.dataset.name === loanItem.name && tag.classList.contains('loan-in')) {
                        isAssigned = true;
                    }
                });
                
                if (isAssigned) break;
            }
            
            if (isAssigned) {
                showNotification('此借入設備已分配到床位，無法刪除', 'error');
                return;
            }
            
            // 从列表中删除
            loanInEquipment.splice(index, 1);
            
            // 更新UI
            initializeLoanInItems();
            
            // 顯示通知
            showNotification('借入設備已刪除');
            
            // 更新統計數值
            updateStatistics();
        }

        // 更新日期和時間
        function updateDateTime() {
            const now = new Date();
            
            // 格式化日期：年/月/日 星期几（增加间距）
            const days = ['日', '一', '二', '三', '四', '五', '六'];
            const dateStr = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')}   星期${days[now.getDay()]}`;
            
            // 格式化时间：时:分
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
        }

        // 頁面切換函數
        function navigateTo(page) {
            localStorage.setItem('currentPage', page);
            window.location.href = page;
        }

        // 添加借入設備到床位的函數
        function addLoanInEquipmentToBed(index, bedNumber) {
            const loanItem = loanInEquipment[index];
            
            // 檢查是否還有可用數量
            if (loanItem.available <= 0) {
                return;
            }
            
            // 獲取床位的設備列表
            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
            
            // 創建設備標籤容器
            const equipmentTag = document.createElement('div');
            equipmentTag.className = 'bed-equipment-tag loan-in';
            equipmentTag.dataset.name = loanItem.name;
            equipmentTag.dataset.source = loanItem.source;
            
            // 創建名稱容器
            const nameContainer = document.createElement('span');
            nameContainer.className = 'equipment-name';
            nameContainer.textContent = loanItem.name;
            
            // 創建刪除按鈕
            const deleteButton = document.createElement('span');
            deleteButton.className = 'delete-equipment';
            deleteButton.innerHTML = '×';
            deleteButton.onclick = function(e) {
                e.stopPropagation();
                removeEquipmentFromBed(this);
            };
            
            // 組裝元素
            equipmentTag.appendChild(nameContainer);
            equipmentTag.appendChild(deleteButton);
            equipmentList.appendChild(equipmentTag);
            
            // 減少借入設備的可用數量
            loanItem.available--;
            
            // 更新借入設備列表
            initializeLoanInItems();
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }

        // 添加借出設備到床位的函數
        function addLoanOutEquipmentToBed(name, bedNumber) {
            // 獲取床位的設備列表
            const equipmentList = document.querySelector(`.bed-equipment-list[data-bed-number="${bedNumber}"]`);
            
            // 檢查是否已經有相同的設備
            const existingTags = Array.from(equipmentList.querySelectorAll('.bed-equipment-tag'));
            const hasSameEquipment = existingTags.some(tag => 
                tag.dataset.name === name && tag.classList.contains('loan-out')
            );
            
            if (hasSameEquipment) {
                return;
            }
            
            // 創建設備標籤
            const equipmentTag = document.createElement('div');
            equipmentTag.className = 'bed-equipment-tag loan-out';
            equipmentTag.textContent = name;
            equipmentTag.dataset.name = name;
            
            // 添加刪除按鈕
            const deleteButton = document.createElement('span');
            deleteButton.className = 'delete-equipment';
            deleteButton.textContent = '×';
            deleteButton.setAttribute('onclick', 'removeEquipmentFromBed(this)');
            
            equipmentTag.appendChild(deleteButton);
            equipmentList.appendChild(equipmentTag);
            
            // 更新統計數據
            updateStatistics();
            
            // 保存點班數據
            saveChecklistData();
        }

        // 初始化床號數據
        function initializeBeds() {
            // 初始化床號按鈕或列表
            const bedContainer = document.querySelector('.bed-container'); // 或者你的設備點班系統中顯示床號的容器
            bedContainer.innerHTML = ''; // 清空現有床號
            
            // 獲取床號配置和總床位數量
            let bedConfig = JSON.parse(localStorage.getItem('bedConfig')) || {};
            const savedTotalBeds = parseInt(localStorage.getItem('totalBeds')) || totalBeds;
            
            // 生成床號元素
            for (let i = 0; i < savedTotalBeds; i++) {
                const bedId = `bed_${i}`;
                // 使用自定義名稱或默認名稱
                const displayName = bedConfig[bedId] || (i + 1).toString();
                
                // 創建床號元素 (根據你的設備點班系統的具體實現來調整)
                const bedElement = document.createElement('div');
                bedElement.className = 'bed-item';
                bedElement.dataset.index = i;
                bedElement.textContent = displayName;
                
                // 添加點擊事件或其他必要的功能
                
                bedContainer.appendChild(bedElement);
            }
        }
    </script>
</body>
</html> 